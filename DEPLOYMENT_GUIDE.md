# Deployment Guide - htmlxify with Backend API

This guide explains how to deploy your htmlxify website and backend to the internet so it works for everyone.

## Overview

When you publish a website online, you need:

1. **Frontend** (HTML/CSS/JS) - Hosted on web server
2. **Backend** (API) - Hosted on separate server (or same server)
3. **Configuration** - Tell frontend where backend is

The htmlxify compiler generates frontend files that need to know where to find your backend.

## Architecture

### Local Development
```
Your Computer
â”œâ”€â”€ Backend Server (localhost:5000)
â””â”€â”€ Browser (localhost)
    â†“ (localhost)
    HTTP requests
```

### Production (Internet)
```
Your Server (yourdomain.com)
â”œâ”€â”€ Web Server (Frontend HTML/CSS/JS)
â””â”€â”€ Backend API Server (api.yourdomain.com or same server)
    â†“ (HTTPS)
    HTTP requests
```

## How Automatic API URL Detection Works

The JavaScript generated by htmlxify is smart about finding your API:

### Priority Order (Highest to Lowest)

1. **`window.API_BASE_URL`** (if you set it in script)
   ```javascript
   window.API_BASE_URL = 'https://api.example.com';
   ```

2. **`meta[name="api-url"]`** (if you set it in HTML)
   ```html
   <meta name="api-url" content="https://api.example.com">
   ```

3. **Environment Auto-Detection**
   - If NOT on localhost â†’ Uses `/api` (relative URL)
   - If on localhost â†’ Uses `http://localhost:5000/api`

### Examples

**Development (localhost):**
```javascript
// Browser: http://localhost:3000
// Generated JavaScript detects: localhost
// Auto-uses: http://localhost:5000/api âœ“
```

**Production (different domain):**
```javascript
// Browser: https://yourdomain.com
// Generated JavaScript detects: not localhost
// Auto-uses: /api (becomes https://yourdomain.com/api) âœ“
```

**Production (different API domain):**
```javascript
// Browser: https://yourdomain.com
// HTML has: <meta name="api-url" content="https://api.example.com">
// JavaScript uses: https://api.example.com âœ“
```

This means **most of the time, you don't need to change anything!**

## Step 1: Configure API URL for Your Environment

### Automatic Detection (NO Configuration Needed!)

The generated JavaScript **automatically detects** the best API URL:

1. **Checks for `window.API_BASE_URL`** - If you set this in a script, it uses it
2. **Checks for `meta[name="api-url"]`** - If you set this in HTML meta tag, it uses it
3. **Auto-detects if NOT on localhost** - Uses relative URL `/api` for production
4. **Falls back to `localhost:5000`** - Default for local development

**This means:** In most cases, you don't need to do anything! Just deploy your files.

### Option A: Meta Tag (RECOMMENDED - Cleanest)

Edit your HTML file and add this meta tag in the `<head>`:

```html
<head>
  <title>My Page</title>
  <meta name="api-url" content="https://api.yourdomain.com">
  <link rel="stylesheet" href="comprehensive_test.css">
</head>
<body>
  <!-- Your content -->
  <script src="comprehensive_test.js"></script>
</body>
```

**Benefits:** Clean, no JavaScript, easy to change without editing generated code.

### Option B: Global Variable (For Complex Logic)

Add a script before loading the page script:

```html
<script>
  // Set API URL for production
  window.API_BASE_URL = 'https://api.yourdomain.com';
</script>
<script src="comprehensive_test.js"></script>
```

**Benefits:** Fast, works everywhere, supports dynamic logic.

### Option C: Auto-Detect Environment

```html
<script>
  // Auto-detect: localhost uses local backend, production uses remote
  if (window.location.hostname === 'localhost') {
    window.API_BASE_URL = 'http://localhost:5000';
  } else {
    window.API_BASE_URL = 'https://api.yourdomain.com';
  }
</script>
<script src="comprehensive_test.js"></script>
```

**Benefits:** Single HTML file works for both development and production.

### Option D: Use Config File

Create a `config.js` file:

```javascript
// config.js
window.API_BASE_URL = 'https://api.yourdomain.com';
```

Include it before your main script:
```html
<script src="config.js"></script>
<script src="comprehensive_test.js"></script>
```

**Benefits:** Separate configuration from HTML, reusable across multiple pages.

### Option E: Same-Domain Backend (Simplest)

If your backend is on the same domain (like `/api/`), **just deploy your files**:

```html
<!-- No configuration needed! -->
<!-- JavaScript automatically uses: https://yourdomain.com/api -->
<script src="comprehensive_test.js"></script>
```

This works because the auto-detection sees you're NOT on localhost and uses relative URL `/api`.

## Step 2: Choose Hosting

### Option 1: Backend + Frontend on Same Server

**Best for:** Small to medium projects, simple setup

```
Example Server: yourdomain.com
â”œâ”€â”€ /public/
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ style.css
â”‚   â””â”€â”€ script.js
â”œâ”€â”€ /api/
â”‚   â””â”€â”€ backend_server.py
â””â”€â”€ nginx.conf
```

**Setup:**
1. Deploy Flask backend to server
2. Deploy HTML/CSS/JS to same server's public folder
3. Set API_BASE_URL = '/api'

**Popular Hosts:**
- Heroku
- DigitalOcean
- AWS Elastic Beanstalk
- PythonAnywhere

### Option 2: Separate Frontend and Backend

**Best for:** Scalable projects, different teams

```
Frontend Server (CDN):
â”œâ”€â”€ yourdomain.com
â”œâ”€â”€ index.html
â”œâ”€â”€ style.css
â””â”€â”€ script.js

Backend Server:
â””â”€â”€ api.yourdomain.com
    â””â”€â”€ Flask backend
```

**Setup:**
1. Deploy HTML/CSS/JS to CDN (Netlify, Vercel, AWS S3)
2. Deploy backend to separate server
3. Set API_BASE_URL = 'https://api.yourdomain.com/api'

**Popular Hosts:**
- Netlify (Frontend)
- Vercel (Frontend)
- AWS S3 + CloudFront (Frontend)
- DigitalOcean (Backend)
- AWS EC2 (Backend)

## Step 3: Deploy Backend Server

### Using Heroku (Easiest)

1. **Install Heroku CLI:**
   ```bash
   # Install Heroku
   ```

2. **Create Procfile:**
   ```
   web: gunicorn backend_server:app
   ```

3. **Create requirements.txt:**
   ```bash
   pip freeze > requirements.txt
   ```

4. **Deploy:**
   ```bash
   heroku create your-api-name
   heroku config:set FLASK_ENV=production
   git push heroku main
   ```

5. **Your API is now at:**
   ```
   https://your-api-name.herokuapp.com/api/trackCTAClick
   ```

### Using DigitalOcean (More Control)

1. **Create Droplet:**
   - Ubuntu 20.04 LTS
   - 512MB RAM (starter)

2. **Install Dependencies:**
   ```bash
   sudo apt update
   sudo apt install python3-pip python3-venv
   ```

3. **Setup Application:**
   ```bash
   git clone your-repo
   cd your-repo
   python3 -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   ```

4. **Run with Gunicorn:**
   ```bash
   gunicorn -w 4 -b 0.0.0.0:5000 backend_server:app
   ```

5. **Use Systemd to Auto-start:**
   ```bash
   # Create service file
   sudo nano /etc/systemd/system/html6-api.service
   
   [Unit]
   Description=htmlxify Backend API
   After=network.target
   
   [Service]
   Type=notify
   User=www-data
   WorkingDirectory=/home/user/app
   ExecStart=/home/user/app/venv/bin/gunicorn -w 4 backend_server:app
   
   [Install]
   WantedBy=multi-user.target
   ```

5. **Your API is at:**
   ```
   http://your-droplet-ip:5000/api/trackCTAClick
   ```

### Using AWS (Production)

1. **Deploy with Elastic Beanstalk:**
   ```bash
   pip install awsebcli-ce
   eb init -p python-3.9
   eb create production
   eb deploy
   ```

2. **Your API is at:**
   ```
   https://production.xxxxxxxxxx.us-east-1.elasticbeanstalk.com/api
   ```

## Step 4: Deploy Frontend

### Using Netlify (Easiest)

1. **Install Netlify CLI:**
   ```bash
   npm install -g netlify-cli
   ```

2. **Deploy:**
   ```bash
   netlify deploy --prod --dir=output/
   ```

3. **Configure API URL in HTML:**
   ```html
   <script>
     window.API_BASE_URL = 'https://your-api.herokuapp.com/api';
   </script>
   ```

4. **Your site is at:**
   ```
   https://yoursite.netlify.app
   ```

### Using Vercel

1. **Install Vercel CLI:**
   ```bash
   npm install -g vercel
   ```

2. **Deploy:**
   ```bash
   vercel deploy
   ```

3. **Your site is at:**
   ```
   https://yourproject.vercel.app
   ```

### Using AWS S3 + CloudFront

1. **Upload to S3:**
   ```bash
   aws s3 sync output/ s3://my-bucket/
   ```

2. **Configure CloudFront:**
   - Create distribution
   - Set origin to S3 bucket
   - Enable caching

3. **Your site is at:**
   ```
   https://d123abc.cloudfront.net
   ```

## Complete Example: Deploy to Heroku

### Backend Deployment

```bash
# 1. Create Procfile
echo "web: gunicorn backend_server:app" > Procfile

# 2. Create requirements.txt
pip freeze > requirements.txt

# 3. Login to Heroku
heroku login

# 4. Create app
heroku create html6-api

# 5. Deploy
git push heroku main

# 6. Check logs
heroku logs --tail

# Your API is at: https://html6-api.herokuapp.com/api
```

### Frontend Deployment

```bash
# 1. Compile htmlxify
python cli.py comprehensive_test.htmlxify output/

# 2. Add API configuration to HTML
cat > output/config.html << 'EOF'
<script>
  window.API_BASE_URL = 'https://html6-api.herokuapp.com/api';
</script>
EOF

# 3. Deploy to Netlify
netlify deploy --prod --dir=output/

# Your site is at: https://yoursite.netlify.app
```

## CORS Configuration

Make sure your backend allows requests from your frontend domain:

```python
from flask_cors import CORS

app = Flask(__name__)

# For development (allow all origins)
CORS(app)

# For production (allow specific origin)
CORS(app, resources={
    r"/api/*": {
        "origins": ["https://yoursite.netlify.app"],
        "methods": ["GET", "POST", "OPTIONS"],
        "allow_headers": ["Content-Type"]
    }
})
```

## Environment Variables

Store sensitive data in environment variables, not in code:

```python
import os

API_KEY = os.environ.get('API_KEY', 'default-key')
DATABASE_URL = os.environ.get('DATABASE_URL', 'sqlite:///db.sqlite')
ALLOWED_ORIGINS = os.environ.get('ALLOWED_ORIGINS', '*').split(',')
```

Set on Heroku:
```bash
heroku config:set API_KEY=your-secret-key
heroku config:set DATABASE_URL=postgresql://...
```

## SSL/HTTPS

Always use HTTPS in production:

- **Heroku:** Automatic HTTPS
- **DigitalOcean:** Use Let's Encrypt (certbot)
- **AWS:** Use ACM (AWS Certificate Manager)
- **Netlify:** Automatic HTTPS

Enable HTTPS redirect in Flask:
```python
@app.before_request
def force_https():
    if not request.is_secure and not app.debug:
        return redirect(request.url.replace('http://', 'https://'), code=301)
```

## Monitoring & Logging

### Check Backend Logs

**Heroku:**
```bash
heroku logs --tail
```

**DigitalOcean:**
```bash
sudo journalctl -u html6-api -f
```

### Check Frontend Errors

Open browser DevTools (F12) â†’ Console tab to see JavaScript errors and API calls.

### Monitor Performance

- Heroku Metrics dashboard
- DigitalOcean Monitoring
- AWS CloudWatch

## Troubleshooting

### "API is not reachable"

1. **Check if backend is running:**
   ```bash
   curl https://your-api.herokuapp.com/api/health
   ```

2. **Check CORS is enabled:**
   ```python
   CORS(app)
   ```

3. **Check API_BASE_URL in frontend:**
   ```javascript
   console.log('API_BASE_URL:', window.API_BASE_URL);
   ```

### "CORS error in browser"

The frontend and backend are on different domains. Add to backend:

```python
from flask_cors import CORS
CORS(app)
```

### "SSL/HTTPS errors"

Make sure you're using `https://` not `http://` in production:

```javascript
window.API_BASE_URL = 'https://your-api.herokuapp.com/api';  // Correct
// window.API_BASE_URL = 'http://your-api.herokuapp.com/api';  // Wrong
```

## Production Checklist

- [ ] Backend API URL configured in HTML
- [ ] CORS enabled on backend
- [ ] HTTPS/SSL enabled
- [ ] Environment variables set
- [ ] Database configured (if using)
- [ ] Error logging enabled
- [ ] Monitoring set up
- [ ] Backup strategy planned
- [ ] Load testing done
- [ ] Security headers added

## Cost Estimates

- **Heroku:** $7-50/month
- **Netlify (Free tier available):** $0-99/month
- **DigitalOcean:** $5-40/month
- **AWS:** $0-100+/month (variable)

## Next Steps

1. Choose hosting option (Option 1 or 2)
2. Deploy backend server
3. Get public URL for backend
4. Add API configuration to HTML
5. Deploy frontend
6. Test all API endpoints
7. Monitor and optimize

---

**Your website is now live on the internet!** ðŸŽ‰

For help, see:
- `BACKEND_README.md` - API documentation
- `HOW_TO_USE.md` - htmlxify syntax
- `BACKEND_QUICKSTART.md` - Local testing
